<input type="file" id="file" />
<input type="button" id="execBtn" value="处理" />
<div>
  <pre id="result"></pre>
</div>
<script src="./wasm_exec.js"></script>
<script>
function load() {
  const go = new global.Go();
  fetch("./imgpro.wasm").then(response =>
    response.arrayBuffer()
  ).then(bytes =>
    WebAssembly.instantiate(bytes, go.importObject)
  ).then(result => {
    go.run(result.instance)
  });
}
load()
</script>

<script>
function formatResult(result) {
  const data = {};
  Object.keys(result).forEach(key => {
    const valueInfo = result[key];
    console.log('valueInfo', valueInfo);
    switch (valueInfo.Type) {
      case 0:
        data[key] = valueInfo.Int;
        break;
      case 1:
        data[key] = valueInfo.String;
        break;
      case 3:
        data[key] = valueInfo.Rgba;
        break;
      case 4:
        data[key] = valueInfo.Values;
        break;
    }
  });
  return data;
}

</script>
<script>
let cacheFileBuffer;
document.querySelector('#file').addEventListener('change', function() {
  const reader = new FileReader();
  reader.onload = function() {
    const arrayBuffer = this.result;
    cacheFileBuffer = new Uint8Array(arrayBuffer);
  }
  reader.readAsArrayBuffer(this.files[0]);
}, false);

document.querySelector('#execBtn').addEventListener('click', function() {
  if (!cacheFileBuffer) {
    return;
  }
  let result;
  try {
    result = imgExec([
      "size",
      "type",
      "width",
      "height",
      "frame",
      "hue",
      "exif"
    ], cacheFileBuffer);
    document.getElementById("result").innerText = JSON.stringify(formatResult(JSON.parse(result)), null, 2);
  } catch(e) {
    document.getElementById("result").innerText = 'error: ' + e.message
    load()
  }
  
}, false);
</script>